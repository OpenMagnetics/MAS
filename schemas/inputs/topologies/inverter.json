{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "http://openmagnetics.com/schemas/inputs/topologies/inverter.json",
    "title": "inverter",
    "description": "The description of a two level inverter leg excitation",
    "type": "object",
    "properties": {
        "dcBusVoltage": {
            "description": "The DC bus voltage",
            "$ref": "/schemas/utils.json#/$defs/dimensionWithTolerance"
        },
        "vdcRipple": {
            "description": "The ripple of the DC bus voltage",
            "$ref": "/schemas/utils.json#/$defs/dimensionWithTolerance"
        },
        "inverterLegPowerRating": {
            "description": "The power rating of the inverter leg",
            "type": "number"
        },
        "lineRmsCurrent": {
            "description": "The RMS current of the line",
            "$ref": "/schemas/utils.json#/$defs/dimensionWithTolerance"
        },
        "downstreamFilter": {
            "description": "Downstream filter elements if present",
            "$ref": "#/$defs/inverterDownstreamFilter"
        },
        "modulation": {
            "description": "All parameters related to switching",
            "$ref": "#/$defs/modulation"
        },
        "operatingPoints": {
            "description": "A list of operating points",
            "type": "array",
            "items": {
                "$ref": "#/$defs/inverterOperatingPoint"
            },
            "minItems": 1
        }
    },
    "required": [
        "dcBusVoltage",
        "inverterLegPowerRating",
        "lineRmsCurrent",
        "operatingPoints"
    ],
    "$defs": {
        "inverterDownstreamFilter": {
            "description": "Downstream filter elements",
            "title": "inverterDownstreamFilter",
            "type": "object",
            "properties": {
                "filterTopology": {
                    "description": "Filter type",
                    "title": "filterTopologies",
                    "type": "string",
                    "enum": ["L", "LC", "LCL"]
                },
                "inductor": {
                    "description": "L1 inductor used for L, LC or LCL filters",
                    "type": "object",
                    "properties": {
                        "desiredInductance": {
                            "description": "Desired inductance for L1",
                            "$ref": "/schemas/utils.json#/$defs/dimensionWithTolerance"
                        },
                        "resistance": {
                            "description": "Equivalent series resistance",
                            "type": "number"
                        }
                    },
                    "required": ["desiredInductance"]
                },
                "capacitor": {
                    "description": "Capacitor used for LC or LCL filters",
                    "type": "object",
                    "properties": {
                        "desiredCapacitance": {
                            "description": "Capacitance value",
                            "type": "number"
                        },
                        "resistance": {
                            "description": "Equivalent series resistance",
                            "type": "number"
                        }
                    },
                    "required": ["desiredCapacitance"]
                },
                "inductor2": {
                    "description": "Second inductor used for LCL filters",
                    "type": "object",
                    "properties": {
                        "desiredInductance2": {
                            "description": "Desired inductance for L2",
                            "$ref": "/schemas/utils.json#/$defs/dimensionWithTolerance"
                        },
                        "resistance": {
                            "description": "Equivalent series resistance",
                            "type": "number"
                        }
                    },
                    "required": ["desiredInductance2"]
                }
            },
            "required": ["filterTopology", "inductor"],
            "allOf": [
                {
                    "if": { "properties": { "filterTopology": { "enum": ["LC", "LCL"] } } },
                    "then": { "required": ["capacitor"] }
                },
                {
                    "if": { "properties": { "filterTopology": { "const": "LCL" } } },
                    "then": { "required": ["inductor2"] }
                }
            ]
        },
        "modulation": {
            "type" : "object",
            "properties" : {
                "switchingFrequency": {
                    "description": "Switching frequency",
                    "type": "number"
                },
                "pwmType": {
                    "description": "Type of PWM carrier waveform",
                    "title": "pwmType",
                    "type": "string",
                    "enum": ["sawtooth", "triangular"]
                },
                "modulationStrategy": {
                    "description": "Strategy used for modulation",
                    "title": "modulationStrategy",
                    "type": "string",
                    "enum": ["SPWM", "SVPWM", "THIPWM"]
                },
                "riseTime": {
                    "description": "Rise time of the transistors",
                    "type": "number"
                },
                "deadtime": {
                    "description": "Deadtime duration",
                    "type": "number"
                },
                "thirdHarmonicInjectionCoefficient": {
                    "description": "Coefficient for third harmonic injection",
                    "type": "number"
                },
                "modulationDepth": {
                    "description": "Modulation depth",
                    "type": "number"
                }
            },
            "required": [
                "switchingFrequency",
                "pwmType",
                "modulationStrategy",
                "modulationDepth"
            ]
        },
        "inverterOperatingPoint": {
            "description": "The description of one inverter operating point",
            "title": "inverterOperatingPoint",
            "type": "object",
            "properties": {
                "fundamentalFrequency": {
                    "description": "Fundamental frequency",
                    "type": "number"
                },
                "powerFactor": {
                    "description": "Power factor at the operating point",
                    "type": "number"
                },
                "currentPhaseAngle": {
                    "description": "Current phase angle in degrees",
                    "type": "number"
                },
                "outputPower": {
                    "description": "Output power at the operating point",
                    "type": "number"
                },
                "load": {
                    "description": "Load connected to the inverter",
                    "$ref": "#/$defs/inverterLoad"
                }, 
                "operatingTemperature": {
                    "description": "Operating temperature of the Inverter Filter",
                    "type": "number"
                }
            },
            "required": ["fundamentalFrequency", "load"],
            "anyOf": [
                {"required": ["powerFactor"]},
                {"required": ["currentPhaseAngle"]}
            ],
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "load": {
                                "properties": {"loadType": {"const": "grid"}}
                            }
                        }
                    },
                    "then": {
                        "required": ["outputPower"]
                    }
                }
            ]
        },
        "inverterLoad": {
            "description": "The load connected to the inverter",
            "title": "inverterLoad",
            "type": "object",
            "properties": {
                "loadType": {
                    "description": "Type of load",
                    "title": "loadType",
                    "type": "string",
                    "enum": ["grid", "R-L"]
                },
                "resistance": {
                    "description": "Load resistance",
                    "type": "number"
                },
                "inductance": {
                    "description": "Load inductance",
                    "type": "number"
                },
                "phaseVoltage": {
                    "description": "Grid phase voltage",
                    "type": "number"
                },
                "gridFrequency": {
                    "description": "Grid frequency",
                    "type": "number"
                },
                "gridResistance": {
                    "description": "Equivalent grid resistance",
                    "type": "number"
                },
                "gridInductance": {
                    "description": "Equivalent grid inductance",
                    "type": "number"
                }
            },
            "required": ["loadType"],
            "allOf": [
                {
                    "if": {
                        "properties": {"loadType": {"const": "R-L"}}
                    },
                    "then": {
                        "required": ["resistance", "inductance"]
                    }
                },
                {
                    "if": {
                        "properties": {"loadType": {"const": "grid"}}
                    },
                    "then": {
                        "required": ["phaseVoltage", "gridFrequency", "gridResistance", "gridInductance"]
                    }
                }
            ]
        }
    }
}
